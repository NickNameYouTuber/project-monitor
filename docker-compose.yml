version: "3.8"

services:
  frontend:
    build: 
      context: ./front
      dockerfile: Dockerfile
    container_name: project-monitor-frontend
    ports:
      - "7670:7670"
    depends_on:
      - backend
      - signaling
    networks:
      - project-monitor-network
    restart: unless-stopped

  backend:
    build: 
      context: ./newbackend
      dockerfile: Dockerfile
    container_name: project-monitor-backend
    ports:
      - "7671:7671"
    environment:
      - JAVA_OPTS=-Dserver.port=7671
      - DATABASE_URL=jdbc:postgresql://db:5432/nit
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - GIT_REPOS_ROOT=/git-repos
      - JWT_SECRET=dev-secret-key-at-least-256-bits-for-hmac-sha-algorithms-security-requirement
    volumes:
      - gitrepos:/git-repos
    networks:
      - project-monitor-network
    restart: unless-stopped
    depends_on:
      - db
      - git-http

  signaling:
    build:
      context: ./signaling
      dockerfile: Dockerfile
    container_name: project-monitor-signaling
    environment:
      - PORT=7673
      - SIGNALING_PATH=/ws/signaling
    ports:
      - "7673:7673"
    networks:
      - project-monitor-network
    restart: unless-stopped

  git-http:
    image: gitea/gitea:1.21.10
    container_name: project-monitor-git-http
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__server__DOMAIN=localhost
      - GITEA__server__ROOT_URL=http://localhost:7681/
      - GITEA__server__HTTP_PORT=7681
    ports:
      - "7681:7681"
    volumes:
      - gitrepos:/data/git/repositories
    networks:
      - project-monitor-network
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    container_name: project-monitor-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=nit
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "7672:5432"
    networks:
      - project-monitor-network

  runner:
    build:
      context: ./runner
    container_name: project-monitor-runner
    environment:
      - API_URL=http://backend:7671/api
      - RUNNER_TOKEN=dev-runner-token
      - RUNNER_NAME=default-runner
      - WORKSPACE_ROOT=/git-repos
    volumes:
      - gitrepos:/git-repos
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - project-monitor-network
    depends_on:
      - backend
    restart: unless-stopped

networks:
  project-monitor-network:
    driver: bridge

volumes:
  pgdata:
  gitrepos:
